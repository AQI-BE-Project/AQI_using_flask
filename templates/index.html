<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>AQI Prediction</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        /* Searchable dropdown input */
        #stationSearch {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            outline: none;
        }
        #stationSearch:focus {
            border-color: #0077b6;
            box-shadow: 0 0 5px rgba(0, 119, 182, 0.4);
        }

        /* Highlight matched text in options */
        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>AQI Prediction</h1>

    <label for="stationSearch">Search Station:</label>
    <input type="text" id="stationSearch" placeholder="Type station name to search..." />

    <label for="stationSelect">Select Station:</label>
    <select id="stationSelect" disabled>
        <option value="">Select a station</option>
    </select>

    <button id="predictBtn" disabled>Predict AQI</button>

    <div id="aqiResult" class="aqi-display" style="margin-top:20px;">
        <p>Select a station and click Predict AQI to see results.</p>
    </div>
</div>

<script>
const stationSearch = document.getElementById("stationSearch");
const stationSelect = document.getElementById("stationSelect");
const predictBtn = document.getElementById("predictBtn");
const aqiResult = document.getElementById("aqiResult");

let allStations = [];

// Fetch stations from backend
async function loadStations() {
    try {
        const res = await fetch("/stations_list");
        const stations = await res.json();
        allStations = stations;

        populateDropdown(allStations);
        stationSelect.disabled = false;
    } catch (err) {
        console.error("Failed to load stations:", err);
        stationSelect.innerHTML = `<option value="">Error loading stations</option>`;
        stationSelect.disabled = true;
    }
}

// Populate dropdown with optional search highlight
function populateDropdown(stations, highlight="") {
    stationSelect.innerHTML = `<option value="">Select a station</option>`;
    const query = highlight.toLowerCase();

    stations.forEach(station => {
        const opt = document.createElement("option");
        opt.value = station.uid;

        if(query && station.name.toLowerCase().includes(query)) {
            // Highlight matching text
            const regex = new RegExp(`(${query})`, "ig");
            opt.innerHTML = station.name.replace(regex, '<span class="highlight">$1</span>');
        } else {
            opt.textContent = station.name;
        }
        stationSelect.appendChild(opt);
    });
    stationSelect.disabled = stationSelect.options.length <= 1;
}

// Filter dropdown based on search input
stationSearch.addEventListener("input", () => {
    const query = stationSearch.value.toLowerCase();
    const filteredStations = allStations.filter(station =>
        station.name.toLowerCase().includes(query)
    );
    populateDropdown(filteredStations, query);
    predictBtn.disabled = true;
});

stationSelect.addEventListener("change", () => {
    predictBtn.disabled = !stationSelect.value;
});

predictBtn.addEventListener("click", async () => {
    const stationUid = stationSelect.value;
    if (!stationUid) return;

    aqiResult.innerHTML = "<p>Loading AQI prediction...</p>";

    const formData = new FormData();
    formData.append("input1", "");
    formData.append("input2", "");
    formData.append("input3", stationUid);

    try {
        const res = await fetch("/predict", { method: "POST", body: formData });
        const result = await res.json();

        if (result.error) {
            aqiResult.innerHTML = `<p style="color:red;">Error: ${result.error}</p>`;
            return;
        }

        const forecast = JSON.parse(result.json_string);
        let tableHTML = `<table border="1" cellpadding="8" cellspacing="0" style="width:100%; margin-top:15px;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Predicted Avg</th>
                    <th>Predicted Max</th>
                    <th>Predicted Min</th>
                </tr>
            </thead>
            <tbody>`;

        for (let i = 0; i < forecast.Date_val.length; i++) {
            tableHTML += `<tr>
                <td>${forecast.Date_val[i]}</td>
                <td>${forecast.avg_val[i]}</td>
                <td>${forecast.Max[i]}</td>
                <td>${forecast.Min[i]}</td>
            </tr>`;
        }

        tableHTML += "</tbody></table>";

        aqiResult.innerHTML = `
            <h3>Predicted AQI: ${result.result}</h3>
            <p><strong>Station UID:</strong> ${result.input3}</p>
            ${tableHTML}
        `;
    } catch (err) {
        console.error("Prediction error:", err);
        aqiResult.innerHTML = `<p style="color:red;">Prediction failed. See console for details.</p>`;
    }
});

// Initialize station list on page load
loadStations();
</script>
</body>
</html>
